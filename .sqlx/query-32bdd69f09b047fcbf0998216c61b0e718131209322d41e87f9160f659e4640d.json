{
  "db_name": "PostgreSQL",
  "query": "\n                WITH in_progress_count AS (\n                    SELECT COUNT(*)::BIGINT as count\n                    FROM requests\n                    WHERE model = $4\n                        AND state IN ('claimed', 'processing')\n                ),\n                available_slots AS (\n                    SELECT GREATEST(0, $2::BIGINT - (SELECT count FROM in_progress_count)) as slots\n                ),\n                to_claim AS (\n                    SELECT r.id, r.template_id, r.batch_id,\n                           b.id::TEXT as batch_id_str,\n                           b.file_id::TEXT as batch_file_id,\n                           b.endpoint as batch_endpoint,\n                           b.completion_window as batch_completion_window,\n                           b.metadata::TEXT as batch_metadata,\n                           b.output_file_id::TEXT as batch_output_file_id,\n                           b.error_file_id::TEXT as batch_error_file_id,\n                           COALESCE(b.created_by, '') as batch_created_by,\n                           to_char(b.created_at AT TIME ZONE 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS.US\"Z\"') as batch_created_at,\n                           to_char(b.expires_at AT TIME ZONE 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS.US\"Z\"') as batch_expires_at,\n                           to_char(b.cancelling_at AT TIME ZONE 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS.US\"Z\"') as batch_cancelling_at,\n                           b.errors::TEXT as batch_errors,\n                           b.total_requests::TEXT as batch_total_requests\n                    FROM requests r\n                    JOIN batches b ON r.batch_id = b.id\n                    CROSS JOIN available_slots\n                    WHERE r.state = 'pending'\n                        AND r.model = $4\n                        AND r.template_id IS NOT NULL\n                        AND (r.not_before IS NULL OR r.not_before <= $3)\n                        AND b.cancelling_at IS NULL\n                        AND available_slots.slots > 0\n                    ORDER BY b.expires_at ASC\n                    LIMIT LEAST($5, (SELECT slots FROM available_slots))\n                    FOR UPDATE OF r SKIP LOCKED\n                )\n                UPDATE requests r\n                SET\n                    state = 'claimed',\n                    daemon_id = $1,\n                    claimed_at = $3\n                FROM to_claim tc\n                JOIN request_templates t ON tc.template_id = t.id\n                JOIN batches b ON tc.batch_id = b.id\n                WHERE r.id = tc.id\n                RETURNING r.id, r.batch_id, r.template_id as \"template_id!\", r.retry_attempt,\n                          t.custom_id, t.endpoint as \"endpoint!\", t.method as \"method!\", t.path as \"path!\",\n                          r.escalated_from_request_id, r.is_escalated, r.escalated_model, r.escalated_api_key, r.superseded_at, r.superseded_by_request_id,\n                          t.body as \"body!\", t.model as \"model!\", t.api_key as \"api_key!\",\n                          b.expires_at as batch_expires_at,\n                          tc.batch_id_str as \"batch_id_str!\",\n                          tc.batch_file_id as \"batch_file_id!\",\n                          tc.batch_endpoint as \"batch_endpoint!\",\n                          tc.batch_completion_window as \"batch_completion_window!\",\n                          tc.batch_metadata as \"batch_metadata\",\n                          tc.batch_output_file_id as \"batch_output_file_id\",\n                          tc.batch_error_file_id as \"batch_error_file_id\",\n                          tc.batch_created_by as \"batch_created_by!\",\n                          tc.batch_created_at as \"batch_created_at!\",\n                          tc.batch_expires_at as \"batch_expires_at_str\",\n                          tc.batch_cancelling_at as \"batch_cancelling_at\",\n                          tc.batch_errors as \"batch_errors\",\n                          tc.batch_total_requests as \"batch_total_requests!\"\n                ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "batch_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 2,
        "name": "template_id!",
        "type_info": "Uuid"
      },
      {
        "ordinal": 3,
        "name": "retry_attempt",
        "type_info": "Int4"
      },
      {
        "ordinal": 4,
        "name": "custom_id",
        "type_info": "Text"
      },
      {
        "ordinal": 5,
        "name": "endpoint!",
        "type_info": "Text"
      },
      {
        "ordinal": 6,
        "name": "method!",
        "type_info": "Text"
      },
      {
        "ordinal": 7,
        "name": "path!",
        "type_info": "Text"
      },
      {
        "ordinal": 8,
        "name": "escalated_from_request_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 9,
        "name": "is_escalated",
        "type_info": "Bool"
      },
      {
        "ordinal": 10,
        "name": "escalated_model",
        "type_info": "Text"
      },
      {
        "ordinal": 11,
        "name": "escalated_api_key",
        "type_info": "Text"
      },
      {
        "ordinal": 12,
        "name": "superseded_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 13,
        "name": "superseded_by_request_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 14,
        "name": "body!",
        "type_info": "Text"
      },
      {
        "ordinal": 15,
        "name": "model!",
        "type_info": "Text"
      },
      {
        "ordinal": 16,
        "name": "api_key!",
        "type_info": "Text"
      },
      {
        "ordinal": 17,
        "name": "batch_expires_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 18,
        "name": "batch_id_str!",
        "type_info": "Text"
      },
      {
        "ordinal": 19,
        "name": "batch_file_id!",
        "type_info": "Text"
      },
      {
        "ordinal": 20,
        "name": "batch_endpoint!",
        "type_info": "Text"
      },
      {
        "ordinal": 21,
        "name": "batch_completion_window!",
        "type_info": "Text"
      },
      {
        "ordinal": 22,
        "name": "batch_metadata",
        "type_info": "Text"
      },
      {
        "ordinal": 23,
        "name": "batch_output_file_id",
        "type_info": "Text"
      },
      {
        "ordinal": 24,
        "name": "batch_error_file_id",
        "type_info": "Text"
      },
      {
        "ordinal": 25,
        "name": "batch_created_by!",
        "type_info": "Text"
      },
      {
        "ordinal": 26,
        "name": "batch_created_at!",
        "type_info": "Text"
      },
      {
        "ordinal": 27,
        "name": "batch_expires_at_str",
        "type_info": "Text"
      },
      {
        "ordinal": 28,
        "name": "batch_cancelling_at",
        "type_info": "Text"
      },
      {
        "ordinal": 29,
        "name": "batch_errors",
        "type_info": "Text"
      },
      {
        "ordinal": 30,
        "name": "batch_total_requests!",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Int8",
        "Timestamptz",
        "Text",
        "Int8"
      ]
    },
    "nullable": [
      false,
      false,
      true,
      false,
      true,
      false,
      false,
      false,
      true,
      false,
      true,
      true,
      true,
      true,
      false,
      false,
      false,
      false,
      null,
      null,
      false,
      false,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "32bdd69f09b047fcbf0998216c61b0e718131209322d41e87f9160f659e4640d"
}
