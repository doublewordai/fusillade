{
  "db_name": "PostgreSQL",
  "query": "\n                WITH to_claim AS (\n                    SELECT r.id, r.template_id, r.batch_id,\n                           b.id::TEXT as batch_id_str,\n                           b.file_id::TEXT as batch_file_id,\n                           b.endpoint as batch_endpoint,\n                           b.completion_window as batch_completion_window,\n                           b.metadata::TEXT as batch_metadata,\n                           b.output_file_id::TEXT as batch_output_file_id,\n                           b.error_file_id::TEXT as batch_error_file_id,\n                           COALESCE(b.created_by, '') as batch_created_by,\n                           to_char(b.created_at AT TIME ZONE 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS.US\"Z\"') as batch_created_at,\n                           to_char(b.expires_at AT TIME ZONE 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS.US\"Z\"') as batch_expires_at,\n                           to_char(b.cancelling_at AT TIME ZONE 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS.US\"Z\"') as batch_cancelling_at,\n                           b.errors::TEXT as batch_errors,\n                           b.total_requests::TEXT as batch_total_requests\n                    FROM requests r\n                    JOIN batches b ON r.batch_id = b.id\n                    WHERE r.state = 'pending'\n                        AND r.model = $4\n                        AND r.template_id IS NOT NULL\n                        AND (r.not_before IS NULL OR r.not_before <= $3)\n                        AND b.cancelling_at IS NULL\n                        AND b.deleted_at IS NULL\n                    ORDER BY b.expires_at ASC\n                    LIMIT LEAST($5::BIGINT, $2::BIGINT)\n                    FOR UPDATE OF r SKIP LOCKED\n                )\n                UPDATE requests r\n                SET\n                    state = 'claimed',\n                    daemon_id = $1,\n                    claimed_at = $3\n                FROM to_claim tc\n                JOIN active_request_templates t ON tc.template_id = t.id\n                JOIN batches b ON tc.batch_id = b.id\n                WHERE r.id = tc.id\n                RETURNING r.id, r.batch_id as \"batch_id!\", r.template_id as \"template_id!\", r.retry_attempt,\n                          t.custom_id, t.endpoint as \"endpoint!\", t.method as \"method!\", t.path as \"path!\",\n                          t.body as \"body!\", t.model as \"model!\", t.api_key as \"api_key!\",\n                          b.expires_at as batch_expires_at,\n                          tc.batch_id_str as \"batch_id_str!\",\n                          tc.batch_file_id as \"batch_file_id!\",\n                          tc.batch_endpoint as \"batch_endpoint!\",\n                          tc.batch_completion_window as \"batch_completion_window!\",\n                          tc.batch_metadata as \"batch_metadata\",\n                          tc.batch_output_file_id as \"batch_output_file_id\",\n                          tc.batch_error_file_id as \"batch_error_file_id\",\n                          tc.batch_created_by as \"batch_created_by!\",\n                          tc.batch_created_at as \"batch_created_at!\",\n                          tc.batch_expires_at as \"batch_expires_at_str\",\n                          tc.batch_cancelling_at as \"batch_cancelling_at\",\n                          tc.batch_errors as \"batch_errors\",\n                          tc.batch_total_requests as \"batch_total_requests!\"\n                ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "batch_id!",
        "type_info": "Uuid"
      },
      {
        "ordinal": 2,
        "name": "template_id!",
        "type_info": "Uuid"
      },
      {
        "ordinal": 3,
        "name": "retry_attempt",
        "type_info": "Int4"
      },
      {
        "ordinal": 4,
        "name": "custom_id",
        "type_info": "Text"
      },
      {
        "ordinal": 5,
        "name": "endpoint!",
        "type_info": "Text"
      },
      {
        "ordinal": 6,
        "name": "method!",
        "type_info": "Text"
      },
      {
        "ordinal": 7,
        "name": "path!",
        "type_info": "Text"
      },
      {
        "ordinal": 8,
        "name": "body!",
        "type_info": "Text"
      },
      {
        "ordinal": 9,
        "name": "model!",
        "type_info": "Text"
      },
      {
        "ordinal": 10,
        "name": "api_key!",
        "type_info": "Text"
      },
      {
        "ordinal": 11,
        "name": "batch_expires_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 12,
        "name": "batch_id_str!",
        "type_info": "Text"
      },
      {
        "ordinal": 13,
        "name": "batch_file_id!",
        "type_info": "Text"
      },
      {
        "ordinal": 14,
        "name": "batch_endpoint!",
        "type_info": "Text"
      },
      {
        "ordinal": 15,
        "name": "batch_completion_window!",
        "type_info": "Text"
      },
      {
        "ordinal": 16,
        "name": "batch_metadata",
        "type_info": "Text"
      },
      {
        "ordinal": 17,
        "name": "batch_output_file_id",
        "type_info": "Text"
      },
      {
        "ordinal": 18,
        "name": "batch_error_file_id",
        "type_info": "Text"
      },
      {
        "ordinal": 19,
        "name": "batch_created_by!",
        "type_info": "Text"
      },
      {
        "ordinal": 20,
        "name": "batch_created_at!",
        "type_info": "Text"
      },
      {
        "ordinal": 21,
        "name": "batch_expires_at_str",
        "type_info": "Text"
      },
      {
        "ordinal": 22,
        "name": "batch_cancelling_at",
        "type_info": "Text"
      },
      {
        "ordinal": 23,
        "name": "batch_errors",
        "type_info": "Text"
      },
      {
        "ordinal": 24,
        "name": "batch_total_requests!",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Int8",
        "Timestamptz",
        "Text",
        "Int8"
      ]
    },
    "nullable": [
      false,
      true,
      true,
      false,
      true,
      true,
      true,
      true,
      true,
      true,
      true,
      false,
      null,
      null,
      false,
      false,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "b03e2ae1cd26b3ed50d726f1438205e666e3131f1d0d940151630b5c07ddeed6"
}
