{
  "db_name": "PostgreSQL",
  "query": "\n            UPDATE requests\n            SET\n                state = 'superseded',\n                superseded_at = $2,\n                superseded_by_request_id = $1\n            WHERE\n                -- Find the racing pair: if winner is escalated, find original; if winner is original, find escalated\n                -- LIMIT 1 handles edge case where multiple escalated requests exist for the same original\n                id = (\n                    SELECT CASE\n                        WHEN w.is_escalated THEN w.escalated_from_request_id\n                        ELSE e.id\n                    END\n                    FROM requests w\n                    LEFT JOIN requests e ON e.escalated_from_request_id = w.id AND e.is_escalated = true\n                    WHERE w.id = $1\n                    LIMIT 1\n                )\n                -- Only supersede if not already in a terminal state\n                -- Allow superseding 'failed' requests since that's the point of escalation\n                AND state NOT IN ('completed', 'canceled', 'superseded')\n            RETURNING id\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Timestamptz"
      ]
    },
    "nullable": [
      false
    ]
  },
  "hash": "2eb9f36dff1addf7f8a442065ceca7c594753febc0c5bfc9d9423b4bf193efa3"
}
