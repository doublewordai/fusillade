{
  "db_name": "PostgreSQL",
  "query": "\n                WITH in_progress_count AS (\n                    SELECT COUNT(*)::BIGINT as count\n                    FROM requests\n                    WHERE model = $4\n                        AND state IN ('claimed', 'processing')\n                ),\n                available_slots AS (\n                    SELECT GREATEST(0, $2::BIGINT - (SELECT count FROM in_progress_count)) as slots\n                ),\n                to_claim AS (\n                    SELECT r.id, r.template_id, r.batch_id\n                    FROM requests r\n                    JOIN batches b ON r.batch_id = b.id\n                    CROSS JOIN available_slots\n                    WHERE r.state = 'pending'\n                        AND r.model = $4\n                        AND (r.not_before IS NULL OR r.not_before <= $3)\n                        AND b.cancelling_at IS NULL\n                        AND available_slots.slots > 0\n                    ORDER BY b.expires_at ASC\n                    LIMIT LEAST($5, (SELECT slots FROM available_slots))\n                    FOR UPDATE OF r SKIP LOCKED\n                )\n                UPDATE requests r\n                SET\n                    state = 'claimed',\n                    daemon_id = $1,\n                    claimed_at = $3\n                FROM to_claim tc\n                JOIN request_templates t ON tc.template_id = t.id\n                JOIN batches b ON tc.batch_id = b.id\n                WHERE r.id = tc.id\n                RETURNING r.id, r.batch_id, r.template_id, r.retry_attempt,\n                          r.escalated_from_request_id, r.is_escalated, r.superseded_at, r.superseded_by_request_id,\n                          t.custom_id, t.endpoint, t.method, t.path, t.body, t.model, t.api_key,\n                          b.expires_at as batch_expires_at\n                ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "batch_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 2,
        "name": "template_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 3,
        "name": "retry_attempt",
        "type_info": "Int4"
      },
      {
        "ordinal": 4,
        "name": "escalated_from_request_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 5,
        "name": "is_escalated",
        "type_info": "Bool"
      },
      {
        "ordinal": 6,
        "name": "superseded_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 7,
        "name": "superseded_by_request_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 8,
        "name": "custom_id",
        "type_info": "Text"
      },
      {
        "ordinal": 9,
        "name": "endpoint",
        "type_info": "Text"
      },
      {
        "ordinal": 10,
        "name": "method",
        "type_info": "Text"
      },
      {
        "ordinal": 11,
        "name": "path",
        "type_info": "Text"
      },
      {
        "ordinal": 12,
        "name": "body",
        "type_info": "Text"
      },
      {
        "ordinal": 13,
        "name": "model",
        "type_info": "Text"
      },
      {
        "ordinal": 14,
        "name": "api_key",
        "type_info": "Text"
      },
      {
        "ordinal": 15,
        "name": "batch_expires_at",
        "type_info": "Timestamptz"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Int8",
        "Timestamptz",
        "Text",
        "Int8"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      false,
      true,
      false,
      true,
      true,
      true,
      false,
      false,
      false,
      false,
      false,
      false,
      false
    ]
  },
  "hash": "9a9ff6c3130e7b623fd7f09270764917b9be3dec6d69878b4a8e394c9b3f1b86"
}
